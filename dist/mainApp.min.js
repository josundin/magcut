"use strict";function printa(a,b){for(var c=0,d=0;b>d;d++)console.log(a[c++],a[c++],a[c++],a[c++],a[c++],a[c++],a[c++],a[c++],a[c++],a[c++],a[c++],a[c++],a[c++],a[c++],a[c++],a[c++],"  ",d)}function makeBlob(a,b,c,d){for(var e=0,f=1;d-1>f;f++)for(var g=1;c-1>g;g++){var h=f*c+g;a[h]<=0?(a[h]=b,e++):a[h]=0}console.log("blobSize",e,"px")}function addOne(a,b,c,d,e){var f=d.pop(),g=e.pop();if(f){for(var h=1;c-1>h;h++)for(var i=1;b-1>i;i++){var j=h*b+i;0!==a[j]&&(a[j]=a[j]+TSTEP)}for(var i=0;i<f.length;i++)a[f[i]]=g[i]+TSTEP}}function subtactOne(a,b,c,d,e){for(var f=[],g=[],h=1;c-1>h;h++)for(var i=1;b-1>i;i++){var j=h*b+i;0!==a[j]&&(a[j]=a[j]-TSTEP,a[j]<=0&&(f.push(j),g.push(a[j])))}d.push(f),e.push(g)}function getDistances(a,b,c,d){for(var e=unique(b)[0]-(2*c+2*d-4),f=0,g=0;;){for(var h=1;d-1>h;h++)for(var i=1;c-1>i;i++){var j=h*c+i;if(0===b[j]){var k=[(h-1)*c+i,(h+1)*c+i,h*c+(i-1),h*c+(i+1)];if(-1===b[k[0]]||-1===b[k[1]]||-1===b[k[2]]||-1===b[k[3]]){f++;for(var l=0;l<k.length;l++)if(-1===b[k[l]]){var m=new Vector(1,a[k[l]]-a[j]);b[j]=m.length()}}else if(0!==b[k[0]]||0!==b[k[1]]||0!==b[k[2]]||0!==b[k[3]]){f++;for(var n=[],o=[],l=0;l<k.length;l++)-1!==b[k[l]]&&0!==b[k[l]]&&(n.push(a[k[l]]),o.push(b[k[l]]));var p=_.min(o),m=new Vector(1,a[j]-n[_.indexOf(o,p)]);b[j]=m.length()+p}}}if(g++,f>=e)break}console.log("itterImage",g)}function getGradients(a,b,c,d){for(var e=1;d-1>e;e++)for(var f=1;c-1>f;f++){var g=e*c+f,h=4*a[g]-a[(e-1)*c+f]-a[(e+1)*c+f]-a[e*c+(f-1)]-a[e*c+(f+1)];b[g]=h>=0?h:-h}}function unique(a){var b,c,d={},e=a.length;for(c=0;e>c;c+=1)b=a[c],d[b]?d[b]+=1:d[b]=1;return d}function selectview(a,b){mosaics=b,viewMosaic(mosaics),setupOverlaySelectView("#selectViewContainer",function(){})}function viewMosaic(a){b2=loadCanvas("selectViewContainer"),b2.width=a[0].width,b2.height=a[0].height,b2ctx=b2.getContext("2d"),b2ctx.globalAlpha=.7;for(var b=0;b<mosaics.length;b++)b2ctx.drawImage(mosaics[b],0,0)}function putMosaic(a){b2.width=mosaics[0].width,b2.height=mosaics[0].height,b2ctx.globalAlpha=.5;for(var b=0;b<mosaics.length;b++)b!=a&&b2ctx.drawImage(mosaics[b],0,0);b2ctx.globalAlpha=1,b2ctx.drawImage(mosaics[a],0,0)}function init(){var a=document.getElementById("drop_zone");a.addEventListener("dragover",handleDragOver,!1),a.addEventListener("drop",handleFileSelect,!1),document.querySelector("#files").addEventListener("change",handleFileSelectButton,!1),selDiv=document.querySelector("#selectedFiles")}function handleFileSelectButton(a){if(a.target.files&&window.FileReader){selDiv.innerHTML="",imgSrcs=[];var b=a.target.files;console.log("the files:",b);var c=Array.prototype.slice.call(b);console.log("fore"),c.forEach(function(a){if(a.type.match("image.*")){var b=new FileReader;b.onload=function(b){var c='<img src="'+b.target.result+'">';selDiv.innerHTML+=c,console.log("URL:",a.name),imgSrcs.push(b.target.result)},b.readAsDataURL(a)}}),showStuff()}}function handleFileSelect(a){selDiv.innerHTML="",imgSrcs=[],a.stopPropagation(),a.preventDefault();var b=a.dataTransfer.files,c=Array.prototype.slice.call(b);c.forEach(function(a){if(a.type.match("image.*")){var b=new FileReader;b.onload=function(b){var c='<img src="'+b.target.result+'">';selDiv.innerHTML+=c,console.log("URL:",a.name),imgSrcs.push(b.target.result)},b.readAsDataURL(a)}}),showStuff()}function showStuff(){$("#pre-stitch").show(),$("#pre-stitch2").show()}function start(){$("#chooseFiles").hide(),$("#runAlgo").hide(),stitchImgs=[],$("#stitching").show();var a=document.getElementById("stitching");if(a.scrollIntoView(!0),console.log("LENGTH OF IMAGES",imgSrcs.length),isEmpty(computedHs)){imagesRef=imgSrcs.slice();for(var b=0;b<imgSrcs.length;b++)computedHs[b]={val:!1,bool:!1,H:[]}}return orbImages=imgSrcs.slice(),baseImg(otherImg),!1}function isEmpty(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function handleDragOver(a){a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}function baseImg(a){var b=new Image;b.src=orbImages[index++],stitchImgs.push(b.src),b.onload=function(){stat2.start("features");var c=findScale(b.width,b.height),d=b.width*c|0,e=b.height*c|0;orb=orbObj(d,e),canvas.width=d,canvas.height=e;var f=canvas.getContext("2d");f.drawImage(this,0,0,d,e);var g=f.getImageData(0,0,d,e);orb.setOrbBase(g,d,e),stat2.stop("features"),console.log("features base img:",stat2.log(1),"ms"),a()}}function otherImg(){var a=new Image;a.src=orbImages[index],a.onload=function(){stat2.start("features");var b=findScale(a.width,a.height),c=a.width*b|0,d=a.height*b|0;canvas.width=c,canvas.height=d;var e=canvas.getContext("2d");e.drawImage(this,0,0,c,d);var f=e.getImageData(0,0,c,d);orb.setOrbOther(f,c,d),orb.getNumMatches()>27?(homographies[hindex++]=orb.getHomograph(),stitchImgs.push(orbImages[index]),console.log("homographies",homographies)):console.log("nada",orb.getNumMatches()),stat2.stop("features"),console.log("features other img:",stat2.log(1),"ms"),index<orbImages.length-1?(++index,otherImg()):(computedHs[0].bool?(console.log("INIT DONE"),hComputed()):(console.log("INIT NOT DONE"),stitch=imagewarp("CANVAS",homographies,stitchImgs,selView)),canvas.width=0,canvas.height=0)}}function selView(){computedHs[0]={val:!1,bool:!0,H:homographies.slice()};var a=stitch.getMosaic2();selectview("canvas",a),$("#stitching").hide(),$("#poststitch").show();var b=document.getElementById("selectViewContainer");b.scrollIntoView(!0)}function hComputed(){for(var a=0;a<imgSrcs.length;a++)computedHs[a].val?computedHs[a]={val:!0,bool:!0,H:homographies.slice()}:computedHs[a].val=!1;stitch=imagewarp("CANVAS",homographies,stitchImgs,blobStuff)}function loadCanvas(a){var b=document.createElement("canvas"),c=document.getElementById(a);return b.id=a,c.appendChild(b),b}function createImgObj(a){var b=new Array(imagesRef.length),c=0;if(computedHs[a].val)console.log("VAL else");else{b[c++]=imagesRef[a],computedHs[a].val=!0;for(var d=0;d<imagesRef.length;d++)d!=a&&(b[c++]=imagesRef[d],computedHs[d].val=!1);imgSrcs=b.slice(),computedHs[a].bool?stitch=imagewarp("CANVAS",computedHs[a].H,b,blobStuff):(console.log("!bool"),index=0,hindex=0,start())}}function blobStuff(){console.log("do blob Stuff"),blob?(blob.remove(),blob.createBlobView()):(blob=blobObj(),blob.createBlobView())}var testData=[0,1,1,1,1,1,1,1,1,1,0,1,2,2,2,2,2,2,1,1,0,1,2,3,3,3,3,3,1,1,0,1,2,3,4,4,4,3,1,1,0,1,2,3,4,5,5,3,1,1,0,1,2,3,4,5,5,3,1,1,0,1,2,3,4,4,4,3,1,1,0,1,2,3,3,3,3,3,1,1,0,1,2,2,2,2,2,2,1,1,0,1,1,1,1,1,1,1,1,1],TSTEP=1;!function(a){a.relativeBlobTreshold=function(a,b,c,d,e,f){var g=a,h=c,i=d,j=new profiler;j.add("features"),console.log("clickedPos",f);var k=findBlobs(b,c,d,e),l=k.data[f],m=[];console.log("labled clickedPos",l);for(var n=0;n<k.data.length;n++)k.data[n]!=l?k.data[n]=0:(k.data[n]=-1,m.push(n));console.log("size of blob",m.length,"px"),j.start("features"),getDistances(b,k.data,c,d),j.stop("features"),console.log("distances created in:",j.log(1),"ms");var o=numeric.floor(k.data);console.log("our dists",o.length);for(var n=0;n<m.length;n++)o[m[n]]=0;10==d?printa10(o,10):16==d&&printa(o,16);var p=o.slice();makeBlob(p,g,c,d),console.log("printa myBlob"),10==d?printa10(p,10):16==d&&printa(p,16);var q=[],r=[];return{printId:function(){return console.log("The ID is:",g),this.id},updateThresholdIncreas:function(){return console.log("The ID is:",g),subtactOne(o,h,i,q,r),p=o.slice(),makeBlob(p,g,c,d),console.log("myBlob"),100==o.length?printa10(p,10):256==o.length&&printa(p,16),p},updateThresholdDecreas:function(){return console.log("The ID is:",g),addOne(o,h,i,q,r),p=o.slice(),makeBlob(p,g,c,d),console.log("myBlob"),100==o.length?printa10(p,10):256==o.length&&printa(p,16),p},getBlob:function(){return p}}}}(this);var mosaics=[],scrollValue=0,setupOverlaySelectView=function(){function a(a){var b=a.charAt(0);if("#"===b)var c=document.getElementById(a.slice(1,a.length));else var c=document.getElementById(a);var d={},e=function(a,b){var e,f=a.split(" "),g=f.length;for(e=0;g>e;e+=1)c.attachEvent?c.attachEvent("on"+f[e],b):c.addEventListener(f[e],b,!1);return d};return d.on=e,d.element=c,d}var b=null;return function(c,d){!function(a){return function(){a()}}(d);b=a(c);var e=document.getElementById("ComputingBlobs");b.on("touchstart mousedown",function(a){a.preventDefault?a.preventDefault():a.returnValue&&(a.returnValue=!1),console.log("down, scrollValue:",scrollValue),e.style.display="block"}).on("touchend mouseup",function(){e.scrollIntoView(!0),createImgObj(scrollValue)}).on("DOMMouseScroll mousewheel",function(a){a.preventDefault?a.preventDefault():a.returnValue&&(a.returnValue=!1);var b=a.wheelDelta?a.wheelDelta/40:a.detail?-a.detail:0;b>0&&scrollValue<mosaics.length-1?(scrollValue+=1,putMosaic(scrollValue)):0>b&&scrollValue>0&&(scrollValue-=1,putMosaic(scrollValue))})}}(),b2,b2ctx,canvas=loadCanvas("tmpCanvas"),imgSrcs=[],orbImages=[],imagesRef=[],selDiv="",index=0,hindex=0,homographies=[],orb={},stitch={},stitchImgs=[],computedHs={},stat2=new profiler,result_canvas;stat2.add("features"),document.addEventListener("DOMContentLoaded",init,!1);var blob,finalcanvas=loadCanvas("final-canvas"),mouse={},myblobs1=[];!function(a){a.blobObj=function(){function a(){j=0;var a=f[0],c=b(a);i=[];for(var d={},e=1;e<imagesRef.length;e++)d[e]=14;for(var e=1;e<imagesRef.length;e++){var h=f[e],k=b(h);myblobs1[e]=findDiff(c,k,h.width,h.height,e),h.blobs=myblobs1[e].getData(),console.log("getData",h.blobs);for(var l=0;l<h.blobs.numberOfUnique;l++){for(var m=l+1,n=zeros(h.blobs.data.length),o=0;o<h.blobs.data.length;o++)m===h.blobs.data[o]&&(n[o]=m+j);i.push([n,e])}j+=h.blobs.numberOfUnique}console.log("globalNumberOfUnique",j);for(var e=0;j>e;e++)g[e+1]=!1;return i}function b(a){for(var b=0,c=0,d=new jsfeat.matrix_t(a.width,a.height,jsfeat.F32_t|jsfeat.C1_t),e=new jsfeat.matrix_t(a.width,a.height,jsfeat.F32_t|jsfeat.C1_t),f=new jsfeat.matrix_t(a.width,a.height,jsfeat.F32_t|jsfeat.C1_t),g=new jsfeat.matrix_t(a.width,a.height,jsfeat.U8_t|jsfeat.C1_t),h=0;h<a.height;h++)for(var i=0;i<a.width;i++,b+=4,c+=1)d.data[c]=a.data[b],e.data[c]=a.data[b+1],f.data[c]=a.data[b+2],g.data[c]=a.data[b+3];return[d,e,f,g]}function c(){var a=document.createElement("input");a.type="button",a.className="btn btn-primary",a.value="reset",a.onclick=d;var b=document.getElementById("btn1");b.appendChild(a)}function d(){finalcanvas.width=0,finalcanvas.height=0,$("#btn1").hide();for(var a=0;a<_.size(g);a++)g[a+1]=!1;redrawScrean(h,f,g,mouse.getOffset());var b=document.getElementById("blobs");b.scrollIntoView(!0)}var e={},f={},g={},h={},i=[];$("#btn1").hide(),c();var j=0;return{createBlobView:function(){console.log("create blob view"),result_canvas=loadCanvas("blobs"),f=stitch.getOverlap();var b=stitch.getModOverlap();h=a(),$("#ComputingBlobs").hide(),$("#blobInterface").show(),mouse=interactMouse(h,f,g,f[0].width,f[0].height,b),mouse.setup(0),redrawScrean(h,f,g,mouse.getOffset());var c=document.getElementById("blobs");return c.scrollIntoView(!0),1},getData:function(){return 1},remove:function(){for(var a=1;a<imagesRef.length;a++)console.log("REMOVE:",a),e[a]&&gui.remove(e[a]);d();var b=document.getElementById("blobs");return b.children.blobs.remove(),result_canvas={},g={},f={},myblobs1=[],h={},i=[],1}}}}(this);